name: Release to Firebase Hosting
on:
  push:
    branches:
      - master
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: 3.29.3
      - run: flutter channel stable
      - run: flutter doctor -v
      - uses: actions/checkout@v4
      - run: flutter build web --no-tree-shake-icons --dart-define=${{ secrets.STICKIFY_API }}
      - name: Bump version
        id: versioning
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //g')
          BASE_VERSION=$(echo $VERSION | cut -d+ -f1)
          BUILD_NUMBER=$(echo $VERSION | grep -o '+[0-9]*' | cut -d+ -f2)

          VERSION_PARTS=(${BASE_VERSION//./ })
          VERSION_PARTS[2]=$((VERSION_PARTS[2]+1))
          UPDATED_BASE_VERSION=$(IFS=. ; echo "${VERSION_PARTS[*]}")

          if [ -z "$BUILD_NUMBER" ]; then
              BUILD_NUMBER=0
          fi

          NEW_BUILD_NUMBER=$((BUILD_NUMBER+1))
          echo "New Version: $UPDATED_BASE_VERSION+$NEW_BUILD_NUMBER"

          sed -i "s/version: $VERSION/version: $UPDATED_BASE_VERSION+$NEW_BUILD_NUMBER/g" pubspec.yaml

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -am "Bump version to $UPDATED_BASE_VERSION+$NEW_BUILD_NUMBER"
          git push origin release
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          firebaseServiceAccount: ${{ secrets.FIREBASE_SECRET }}
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          channelId: live
          projectId: stickify
